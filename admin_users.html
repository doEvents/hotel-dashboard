<div class="container mt-4">
    <h4>Manajemen User</h4>
    <hr>
    
    <form id="userForm" class="mb-4">
        <input type="hidden" id="userId">
        <div class="row g-2">
            <div class="col-md-3">
                <input type="text" id="username" class="form-control form-control-sm" placeholder="Username" required>
            </div>
            <div class="col-md-3">
                <input type="email" id="email" class="form-control form-control-sm" placeholder="Email" required>
            </div>
            <div class="col-md-2">
                <input type="password" id="password" class="form-control form-control-sm" placeholder="Password" required>
            </div>
            <div class="col-md-2">
                <select id="group" class="form-select form-select-sm" required>
                    <option value="">Pilih Group</option>
                    <option value="admin">Admin</option>
                    <option value="supervisor">Supervisor</option>
                    <option value="staf">Staf</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" id="btnSubmit" class="btn btn-sm btn-primary shadow-sm w-100">
                    <i class="fas fa-plus"></i> Simpan User
                </button>
            </div>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm">
            <thead class="table-light">
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Password (Hash)</th>
                    <th>Group</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    const dbName = "UserDB";
    const storeName = "users";
    let db;

    // 1. Inisialisasi Database
    const request = indexedDB.open(dbName, 1);

    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains(storeName)) {
            db.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
        }
    };

    request.onsuccess = (e) => {
        db = e.target.result;
        displayData();
    };

    // 2. Fungsi Enkripsi Password (SHA-256 Hashing)
    async function hashPassword(password) {
        const msgUint8 = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // 3. Tambah atau Update Data
    document.getElementById('userForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('userId').value;
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const group = document.getElementById('group').value;

        // Enkripsi password sebelum disimpan
        const hashedPassword = await hashPassword(password);

        const transaction = db.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);

        const userData = { username, email, password: hashedPassword, group };
        
        if (id) {
            userData.id = Number(id);
            store.put(userData);
        } else {
            store.add(userData);
        }

        transaction.oncomplete = () => {
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            displayData();
        };
    });

    // 4. Tampilkan Data
    function displayData() {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        const store = db.transaction(storeName).objectStore(storeName);
        store.openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const row = `
                    <tr>
                        <td>${cursor.value.username}</td>
                        <td>${cursor.value.email}</td>
                        <td><small class="text-muted">${cursor.value.password.substring(0, 10)}...</small></td>
                        <td><span class="badge bg-secondary">${cursor.value.group}</span></td>
                        <td>
                            <button onclick="editUser(${cursor.value.id})" class="btn btn-xs btn-warning py-0 px-1">Edit</button>
                            <button onclick="deleteUser(${cursor.value.id})" class="btn btn-xs btn-danger py-0 px-1">Hapus</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
                cursor.continue();
            }
        };
    }

    // 5. Edit Data
    window.editUser = (id) => {
        const transaction = db.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.get(id);

        request.onsuccess = () => {
            const user = request.result;
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('group').value = user.group;
            // Password tidak dimuat balik karena sudah di-hash
            document.getElementById('password').placeholder = "Masukkan password baru";
        };
    };

    // 6. Hapus Data
    window.deleteUser = (id) => {
        if (confirm('Hapus user ini?')) {
            const transaction = db.transaction([storeName], "readwrite");
            transaction.objectStore(storeName).delete(id);
            transaction.oncomplete = () => displayData();
        }
    };
</script>
