

<div class="nebula-wrapper mt-4">
    <div class="container-fluid">
        <h4><i class="fas fa-atom me-2"></i>USER NEBULA CORE</h4>
        <p class="text-muted small">Local Database System v1.0 (Encrypted)</p>
        
        <div class="nebula-card mb-4">
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="small text-muted">Username</label>
                        <input type="text" id="username" class="form-control form-control-sm" placeholder="Enter username" required>
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted">Email Address</label>
                        <input type="email" id="email" class="form-control form-control-sm" placeholder="user@nebula.com" required>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">Access Key</label>
                        <input type="password" id="password" class="form-control form-control-sm" placeholder="Password" required>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">Rank Group</label>
                        <select id="group" class="form-select form-select-sm" required>
                            <option value="">Choose...</option>
                            <option value="admin">Admin</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="staf">Staf</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" id="btnSubmit" class="btn btn-sm btn-primary shadow-sm w-100 py-2">
                            <i class="fas fa-plus-circle me-1"></i> SIMPAN USER
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <div class="nebula-card">
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead>
                        <tr>
                            <th>IDENTIFIER</th>
                            <th>EMAIL</th>
                            <th>SECURITY HASH</th>
                            <th>RANK</th>
                            <th class="text-center">OPERATIONS</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const dbName = "NebulaDB";
    const storeName = "users";
    let db;

    // Initialize IndexedDB
    const request = indexedDB.open(dbName, 2);

    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains(storeName)) {
            db.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
        }
    };

    request.onsuccess = (e) => {
        db = e.target.result;
        displayData();
    };

    // SHA-256 Hashing Function
    async function hashPassword(password) {
        const msgUint8 = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Handle Form Submit
    document.getElementById('userForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('userId').value;
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const group = document.getElementById('group').value;

        const hashedPassword = await hashPassword(password);
        const transaction = db.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);

        const userData = { username, email, password: hashedPassword, group };
        
        if (id) {
            userData.id = Number(id);
            store.put(userData);
        } else {
            store.add(userData);
        }

        transaction.oncomplete = () => {
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            displayData();
        };
    });

    // Display Function
    function displayData() {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        const transaction = db.transaction(storeName, "readonly");
        const store = transaction.objectStore(storeName);

        store.openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const u = cursor.value;
                const row = `
                    <tr>
                        <td class="fw-bold text-info">${u.username}</td>
                        <td>${u.email}</td>
                        <td><code>${u.password.substring(0, 12)}...</code></td>
                        <td><span class="badge rounded-pill bg-dark border border-secondary">${u.group}</span></td>
                        <td class="text-center">
                            <button onclick="editUser(${u.id})" class="btn btn-sm btn-outline-warning py-0">Edit</button>
                            <button onclick="deleteUser(${u.id})" class="btn btn-sm btn-outline-danger py-0">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
                cursor.continue();
            }
        };
    }

    // Edit Function
    window.editUser = (id) => {
        const store = db.transaction([storeName], "readonly").objectStore(storeName);
        store.get(id).onsuccess = (e) => {
            const user = e.target.result;
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('group').value = user.group;
            document.getElementById('password').placeholder = "Re-enter to update";
        };
    };

    // Delete Function
    window.deleteUser = (id) => {
        if (confirm('Erase this user from Nebula Core?')) {
            const transaction = db.transaction([storeName], "readwrite");
            transaction.objectStore(storeName).delete(id);
            transaction.oncomplete = () => displayData();
        }
    };
</script>
