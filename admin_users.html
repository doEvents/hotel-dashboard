<script src="https://unpkg.com/dexie/dist/dexie.js"></script>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-0">Manajemen Users</h4>
            <small class="text-muted" id="sync-status">Status: Mengecek koneksi...</small>
        </div>
        <div class="d-flex gap-2">
            <button onclick="syncDataManual()" class="btn btn-sm btn-outline-info shadow-sm">
                <i class="bi bi-arrow-repeat"></i> Sync
            </button>
            <button onclick="$('#modalUser').modal('show')" class="btn btn-sm btn-primary shadow-sm px-3">
                <i class="bi bi-person-plus-fill me-2"></i>Tambah User
            </button>
        </div>
    </div>

    <div class="card bg-secondary bg-opacity-10 border border-secondary border-opacity-25 rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr class="text-muted small text-uppercase">
                        <th class="ps-4 py-3">Username</th>
                        <th>Role</th>
                        <th>Sync Status</th>
                        <th class="text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="user-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalUser" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary border-opacity-50 text-white" style="border-radius: 20px;">
            <div class="modal-header border-secondary border-opacity-25">
                <h5 class="modal-title fw-bold">User Baru</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label text-muted">Username</label>
                    <input type="text" id="u_name" class="form-control bg-secondary bg-opacity-10 border-secondary border-opacity-25 text-white shadow-none">
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Role</label>
                    <select id="u_role" class="form-select bg-secondary bg-opacity-10 border-secondary border-opacity-25 text-white shadow-none">
                        <option value="Admin">Admin</option>
                        <option value="Staff">Staff</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer border-secondary border-opacity-25">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                <button onclick="addUser()" class="btn btn-sm btn-primary shadow-sm px-4">Simpan Lokal</button>
            </div>
        </div>
    </div>
</div>

<script>
    const SHEET_NAME = 'Users';

    // 1. Inisialisasi IndexedDB (Dexie) tetap sama
    const db = new Dexie("NebulaDB");
    db.version(1).stores({
        users: '++id, username, role, sync_status'
    });

    
    // 2. Fungsi Render Tabel dari Lokal
    async function syncDataToCloud() {
        if(!navigator.onLine) return;

        const pendingData = await db.users.where("sync_status").equals(0).toArray();
        if(pendingData.length === 0) {
            $('#sync-status').text("Status: Terkoneksi & Sinkron");
            return;
        }

        $('#sync-status').text(`Status: Menyinkronkan ${pendingData.length} data...`);

        for(let item of pendingData) {
            try {
                // MENGGUNAKAN window.SCRIPT_URL secara langsung
                const res = await fetch(window.SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: JSON.stringify({
                        action: "add",
                        sheetName: SHEET_NAME,
                        data: { Username: item.username, Role: item.role }
                    })
                });
                
                await db.users.update(item.id, { sync_status: 1 });
            } catch (e) {
                console.error("Sync Error:", e);
            }
        }
        renderLocalTable();
        $('#sync-status').text("Status: Sinkronisasi Selesai");
    }

    // 3. Tambah User (Offline-First)
    async function addUser() {
        const user = {
            username: $('#u_name').val(),
            role: $('#u_role').val(),
            sync_status: 0 // Default pending
        };

        if(!user.username) return alert("Isi username!");

        await db.users.add(user);
        $('#modalUser').modal('hide');
        renderLocalTable();
        
        // Coba sync jika online
        if(navigator.onLine) syncDataToCloud();
    }

    // 4. Engine Sinkronisasi (PWA Power)
    async function syncDataToCloud() {
        if(!navigator.onLine) return;

        const pendingData = await db.users.where("sync_status").equals(0).toArray();
        if(pendingData.length === 0) {
            $('#sync-status').text("Status: Terkoneksi & Sinkron");
            return;
        }

        $('#sync-status').text(`Status: Menyinkronkan ${pendingData.length} data...`);

        for(let item of pendingData) {
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Untuk menghindari masalah CORS pada Google Script
                    body: JSON.stringify({
                        action: "add",
                        sheetName: SHEET_NAME,
                        data: { Username: item.username, Role: item.role }
                    })
                });
                
                // Update status di lokal setelah berhasil kirim
                await db.users.update(item.id, { sync_status: 1 });
            } catch (e) {
                console.error("Sync Error:", e);
            }
        }
        renderLocalTable();
        $('#sync-status').text("Status: Sinkronisasi Selesai");
    }

    // 5. Hapus User
    async function deleteUser(localId, username) {
        if(confirm(`Hapus ${username}?`)) {
            await db.users.delete(localId);
            // Tambahkan logika hapus di cloud jika perlu
            renderLocalTable();
        }
    }

    // Auto sync saat koneksi kembali online
    window.addEventListener('online', syncDataToCloud);
    
    // Muat data awal
    renderLocalTable();
    syncDataToCloud();

</script>
