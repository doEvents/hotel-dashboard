<style>
    /* Nebula Card Styling */
    .nebula-card {
        background: var(--sidebar-bg);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    /* Modal Styling */
    .modal-content {
        background-color: #111622; 
        border: 1px solid var(--border-color);
        border-radius: 24px;
        color: var(--text-main);
    }

    .modal-header { border-bottom: 1px solid var(--border-color); }
    .modal-footer { border-top: 1px solid var(--border-color); }

    /* Form Input & Dropdown Nebula */
    .form-control {
        background-color: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-main) !important;
        border-radius: 12px;
    }

    .form-select {
        background-color: #1a1f2b !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-main) !important;
        border-radius: 12px;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
    }

    .form-select option {
        background-color: #111622 !important;
        color: #ffffff !important;
    }

    /* Table & Badge */
    .table { color: var(--text-main); border-color: var(--border-color); }
    .table thead th {
        background: rgba(255, 255, 255, 0.02);
        color: var(--text-muted);
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 1px;
    }

    .user-badge {
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
    }

    /* Custom Button sesuai Instruksi */
    .btn-primary.shadow-sm {
        background: var(--accent-glow) !important;
        border: none !important;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-0 text-white">User Management</h4>
            <p class="text-muted small mb-0">Database Lokal: Store 'users'</p>
        </div>
        <button class="btn btn-sm btn-primary shadow-sm px-4 py-2 rounded-pill fw-bold" onclick="openUserModal()">
            <i class="bi bi-person-plus-fill me-2"></i>Tambah User
        </button>
    </div>

    <div class="nebula-card">
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Group</th>
                        <th>Security Hash</th>
                        <th class="text-end">Aksi</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-white">User Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="userForm">
                <div class="modal-body">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label class="form-label">USERNAME</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">EMAIL ADDRESS</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ACCESS PASSWORD</label>
                        <input type="password" id="password" class="form-control">
                        <small id="passHelp" class="text-muted" style="font-size: 10px;"></small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">RANK / GROUP</label>
                        <select id="group" class="form-select" required>
                            <option value="" disabled selected>Pilih group...</option>
                            <option value="admin">Admin</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="staf">Staf</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-link text-muted text-decoration-none" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-sm btn-primary shadow-sm px-4 py-2 rounded-pill fw-bold">Simpan User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // FIX: Gunakan fallback jika window.DB_NAME belum didefinisikan
    var dbName = window.app_name || "NebulaCoreDB";
    var storeName = "users";
    var db;
    var userModal = new bootstrap.Modal(document.getElementById('userModal'));

    // FIX: Naikkan versi ke 2 untuk memaksa pembuatan tabel 'users'
    var request = indexedDB.open(dbName, 2);

    request.onupgradeneeded = (e) => {
        var dbInstance = e.target.result;
        console.log("Upgrading Database...");
        if (!dbInstance.objectStoreNames.contains(storeName)) {
            dbInstance.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
            console.log("Store 'users' created.");
        }
    };

    request.onsuccess = (e) => {
        db = e.target.result;
        console.log("Database Connection Success.");
        loadUsers();
    };

    request.onerror = (e) => {
        console.error("Database Error:", e.target.errorCode);
    };

    async function hashPassword(password) {
        const msgUint8 = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function openUserModal() {
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('password').required = true;
        document.getElementById('passHelp').innerText = "Password akan di-hash SHA-256";
        userModal.show();
    }

    document.getElementById('userForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('userId').value;
        const passVal = document.getElementById('password').value;
        
        const userData = {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            group: document.getElementById('group').value
        };

        const transaction = db.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);

        if (id) {
            userData.id = Number(id);
            if (passVal) {
                userData.password = await hashPassword(passVal);
            } else {
                const existing = await new Promise(res => {
                    store.get(userData.id).onsuccess = (ev) => res(ev.target.result);
                });
                userData.password = existing.password;
            }
            store.put(userData);
        } else {
            userData.password = await hashPassword(passVal);
            store.add(userData);
        }

        transaction.oncomplete = () => { 
            userModal.hide(); 
            loadUsers(); 
        };
    };

    function loadUsers() {
        // FIX: Tambahkan pengecekan store sebelum transaksi
        if (!db.objectStoreNames.contains(storeName)) {
            console.warn("Store not found yet. Database might be updating.");
            return;
        }

        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';
        const transaction = db.transaction(storeName, "readonly");
        const store = transaction.objectStore(storeName);

        store.openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const u = cursor.value;
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-white">${u.username}</td>
                        <td class="text-muted small">${u.email}</td>
                        <td><span class="user-badge">${u.group}</span></td>
                        <td><code class="text-info" style="font-size: 10px;">${u.password.substring(0, 10)}...</code></td>
                        <td class="text-end">
                            <button onclick="editUser(${u.id})" class="btn btn-sm btn-outline-info border-0"><i class="bi bi-pencil-square"></i></button>
                            <button onclick="deleteUser(${u.id})" class="btn btn-sm btn-outline-danger border-0"><i class="bi bi-trash3"></i></button>
                        </td>
                    </tr>`;
                cursor.continue();
            }
        };
    }

    window.editUser = (id) => {
        db.transaction(storeName).objectStore(storeName).get(id).onsuccess = (e) => {
            const u = e.target.result;
            document.getElementById('userId').value = u.id;
            document.getElementById('username').value = u.username;
            document.getElementById('email').value = u.email;
            document.getElementById('group').value = u.group;
            document.getElementById('password').required = false;
            document.getElementById('passHelp').innerText = "Kosongkan jika tidak ingin ganti password";
            userModal.show();
        };
    };

    window.deleteUser = (id) => {
        if (confirm('Hapus user ini?')) {
            db.transaction(storeName, "readwrite").objectStore(storeName).delete(id).oncomplete = () => loadUsers();
        }
    };
</script>
